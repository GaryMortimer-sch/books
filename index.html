<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clifton Book Drive 2025</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js for reliable and aesthetic charting -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <!-- Set Inter font for modern look -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
    </style>
</head>
<body>

    <div id="app" class="min-h-screen">
        <header class="text-center py-6 bg-white shadow-md sticky top-0 z-10">
            <!-- Updated header title color to red-700 -->
            <h1 class="text-3xl sm:text-4xl font-extrabold text-red-700">Clifton Book Drive 2025</h1>
            <!-- Status now reflects Real-time database connection -->
            <p id="auth-status" class="mt-1 text-xs font-semibold text-blue-500">
                Connecting to Real-time Database...
            </p>
        </header>

        <!-- Navigation Bar -->
        <nav class="flex justify-center bg-gray-100 p-3 shadow-inner">
            <button id="nav-dashboard" onclick="navigate('dashboard')" 
                class="px-4 py-2 mx-2 rounded-full font-semibold transition duration-200 
                       bg-red-600 text-white hover:bg-red-700 shadow-md">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                Data Entry
            </button>
            <button id="nav-display" onclick="navigate('display')" 
                class="px-4 py-2 mx-2 rounded-full font-semibold transition duration-200 
                       bg-white text-red-600 hover:bg-red-50 border border-red-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                Live Leaderboard
            </button>
        </nav>

        <!-- --- DASHBOARD (INPUT) SCREEN --- -->
        <div id="dashboard-screen" class="p-4 sm:p-8 max-w-2xl mx-auto">
            <div class="p-6 bg-white rounded-xl shadow-2xl border border-gray-100">
                <!-- Updated heading color to red-600 -->
                <h2 class="text-2xl font-semibold mb-4 text-red-600 border-b pb-2">
                    Update Books Collected Totals
                </h2>
                <div id="loading-inputs" class="text-center py-8">
                    <div class="flex justify-center items-center space-x-2">
                        <div class="h-4 w-4 bg-red-500 rounded-full animate-bounce [animation-delay:-0.3s]"></div>
                        <div class="h-4 w-4 bg-red-500 rounded-full animate-bounce [animation-delay:-0.15s]"></div>
                        <div class="h-4 w-4 bg-red-500 rounded-full animate-bounce"></div>
                    </div>
                    <p class="mt-4 text-gray-500">Loading real-time data...</p>
                </div>
                <!-- Inputs will be rendered here by JavaScript -->
                <div id="input-form" class="space-y-4 hidden"> 
                </div>
                <div id="message-box" class="mt-4 p-3 text-sm rounded-lg text-green-700 bg-green-100 hidden" role="alert"></div>
            </div>
            
            <div id="user-info" class="mt-4 text-center text-xs text-gray-400">
                <!-- User and App ID info will be displayed here -->
            </div>
        </div>

        <!-- --- DISPLAY (CHART) SCREEN --- -->
        <div id="display-screen" class="p-4 sm:p-8 max-w-4xl mx-auto hidden">
            <div class="p-6 bg-white rounded-xl shadow-2xl border border-gray-100">
                <h2 class="text-2xl font-semibold mb-4 text-red-600 border-b pb-2">
                    Live Leaderboard
                </h2>
                
                <!-- Updated border and background colors to use red shades - CHART CONTAINER -->
                <div class="relative w-full overflow-hidden border-4 border-dashed border-red-200 rounded-lg bg-red-50 p-4" style="height: 600px;">
                    <canvas id="fundraisingChart" class="w-full h-full"></canvas>
                    <div id="chart-overlay" class="absolute inset-0 flex items-center justify-center bg-white/70 backdrop-blur-sm hidden">
                        <!-- Updated chart overlay text color to red-600 -->
                        <div class="animate-pulse text-red-600 text-xl font-medium">Chart Updating...</div>
                    </div>
                </div>

                <!-- Total Summary Box (Now below the chart/table) -->
                <div id="total-summary" class="bg-red-50 p-4 mt-6 rounded-lg border-l-4 border-red-600 shadow-inner text-center">
                    <!-- Content will be injected by JavaScript on page load/update -->
                    <div class="text-gray-500">Loading summary...</div>
                </div>
                
                <!-- FINAL NOTE - After chart and summary -->
                <div class="mt-4 text-center">
                    <p class="text-sm text-gray-500">The current leader is highlighted with a **Golden** bar!</p>
                </div>
            </div>
        </div>

    </div>

    <!-- Firebase and Chart Logic -->
    <script type="module">
        // Firebase SDK Imports
        import { initializeApp as initApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth as authFn, 
            signInAnonymously as signInAnon, 
            signInWithCustomToken as signInCustom, 
            onAuthStateChanged as onAuthChange 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore as dbFn, 
            doc as docRef, 
            setDoc as setDocFn, 
            onSnapshot as onSnapshotFn, 
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE GLOBALS ---
        let app;
        let auth;
        let db;
        let appId;
        let userId = 'unknown';
        let isAuthReady = false; 

        // --- APP GLOBALS ---
        let currentData = null; 
        let currentPage = 'dashboard'; 
        let chartInstance = null; 

        // --- DOM ELEMENTS ---
        const canvas = document.getElementById('fundraisingChart');
        const inputForm = document.getElementById('input-form');
        const messageBox = document.getElementById('message-box');
        const loadingInputs = document.getElementById('loading-inputs');
        const authStatus = document.getElementById('auth-status');
        const userInfo = document.getElementById('user-info');
        
        const dashboardScreen = document.getElementById('dashboard-screen');
        const displayScreen = document.getElementById('display-screen');
        const navDashboard = document.getElementById('nav-dashboard');
        const navDisplay = document.getElementById('nav-display');
        
        // Initial list of classes to track - This defines the chart display order now.
        const CLASS_LIST = ['3F', '3V', '4S', '4T', '5L', '5N', '5W', '6NW', '6SW', '7B', '7KV', '7SV'];
        
        // Default data structure if no data exists (used for initial Firestore write if doc doesn't exist)
        const DEFAULT_DATA = CLASS_LIST.reduce((acc, className) => {
            acc[className] = 1; 
            return acc;
        }, {});
        
        // Pallete of colors for the chart
        const BAR_COLORS = [
            '#ef4444', '#f97316', '#eab308', '#22c55e', '#06b6d4', 
            '#3b82f6', '#8b5cf6', '#ec4899', '#6b7280', '#ca8a04', 
            '#16a34a', '#075985',
        ];

        // --- NAVIGATION FUNCTIONS ---
        
        /**
         * Switches the active screen view and ensures the chart is redrawn if needed.
         */
        window.navigate = function(page) {
            currentPage = page;

            // Update visibility
            dashboardScreen.classList.toggle('hidden', page !== 'dashboard');
            displayScreen.classList.toggle('hidden', page !== 'display');

            // Update navigation button styles 
            navDashboard.className = `px-4 py-2 mx-2 rounded-full font-semibold transition duration-200 shadow-md ${page === 'dashboard' ? 'bg-red-600 text-white hover:bg-red-700' : 'bg-white text-red-600 hover:bg-red-50 border border-red-600'}`;
            navDisplay.className = `px-4 py-2 mx-2 rounded-full font-semibold transition duration-200 shadow-md ${page === 'display' ? 'bg-red-600 text-white hover:bg-red-700' : 'bg-white text-red-600 hover:bg-red-50 border border-red-600'}`;

            // Re-render chart if navigating to the display page AND data is loaded
            if (page === 'display' && currentData) {
                renderChart(currentData);
            }
        }


        // --- UTILITY FUNCTIONS ---

        /**
         * Shows a temporary confirmation message.
         */
        function showMessage(message) {
            messageBox.textContent = message;
            messageBox.classList.remove('hidden', 'bg-red-100', 'text-red-700');
            messageBox.classList.add('bg-green-100', 'text-green-700');
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 3000);
        }
        
        /**
         * Shows a temporary error message.
         */
         function showError(message) {
            messageBox.textContent = message;
            messageBox.classList.remove('hidden', 'bg-green-100', 'text-green-700');
            messageBox.classList.add('bg-red-100', 'text-red-700');
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000);
        }

        /**
         * Converts the class object data into {labels, totals} arrays in CLASS_LIST order,
         * and finds the grand total and current leader. No sorting is applied to the chart data.
         */
        function prepareData(data) {
            if (!data) return { labels: [], totals: [], grandTotal: 0, leader: { name: '', total: -1 } };
            
            let grandTotal = 0;
            let leader = { name: '', total: -1 };

            const chartLabels = [];
            const chartTotals = [];
            
            CLASS_LIST.forEach(className => {
                // Ensure data read from Firestore is treated as an integer, default to 1 if missing or invalid
                const total = parseInt(data[className] || 1); 
                grandTotal += total; 
                
                chartLabels.push(className);
                chartTotals.push(total);
                
                // Check for leader while iterating (handles ties by keeping the first class found)
                if (total > leader.total) {
                    leader = { name: className, total: total };
                }
            });
            
            return { labels: chartLabels, totals: chartTotals, grandTotal, leader };
        }

        // --- FIREBASE DATA FUNCTIONS ---

        /**
         * Sets up the real-time listener for the public score document.
         */
        function startRealtimeListener() {
            if (!db || !appId) {
                console.error("Firestore not initialized.");
                return;
            }

            // Public path for shared data: /artifacts/{appId}/public/data/book_drive_scores/current_scores
            const scoreDocRef_ = docRef(db, 'artifacts', appId, 'public', 'data', 'book_drive_scores', 'current_scores');
            
            onSnapshotFn(scoreDocRef_, (docSnap) => {
                if (!isAuthReady) return; // Wait for initial auth/setup to finish

                if (docSnap.exists()) {
                    // Data exists, update the global state and UI
                    currentData = docSnap.data();
                    console.log("Real-time data updated:", currentData);
                } else {
                    // Document does not exist yet, initialize it with default data
                    console.log("No data found, initializing document with default scores.");
                    setDocFn(scoreDocRef_, { ...DEFAULT_DATA, initialized: true }).catch(e => console.error("Error initializing data:", e));
                    currentData = DEFAULT_DATA;
                }
                
                // Render UI after data is loaded/updated
                loadingInputs.classList.add('hidden');
                inputForm.classList.remove('hidden');
                renderInputs(currentData);
                if (currentPage === 'display') {
                    renderChart(currentData);
                }
            }, (error) => {
                console.error("Firestore listening error:", error);
                authStatus.textContent = "Error loading data. Check console.";
                loadingInputs.innerHTML = '<p class="text-red-600">Failed to load data. See console for details.</p>';
                inputForm.classList.add('hidden');
            });
        }

        /**
         * Updates a single class's total in the remote Firestore document.
         */
        async function updateRemoteData(className, total) {
            if (!db || !appId || !isAuthReady) {
                console.warn("Database not ready or not authenticated.");
                return;
            }

            const scoreDocRef_ = docRef(db, 'artifacts', appId, 'public', 'data', 'book_drive_scores', 'current_scores');
            
            // Use an object to update only the specific field, merging with existing data
            const updateObject = { [className]: total };

            try {
                await setDocFn(scoreDocRef_, updateObject, { merge: true });
                showMessage(`${className} total updated to ${total} books collected.`);
                // Note: The onSnapshot listener will handle updating currentData and redrawing the UI
            } catch (e) {
                console.error("Error writing document: ", e);
                showError(`Failed to save data for ${className}.`);
            }
        }
        
        // --- RENDER FUNCTIONS ---

        /**
         * Renders the input form based on the current data.
         */
        function renderInputs(data) {
            inputForm.innerHTML = ''; 
            
            CLASS_LIST.forEach(className => {
                const currentValue = parseInt(data[className] || 1); // Default to 1

                const div = document.createElement('div');
                div.className = 'flex items-center space-x-3 bg-gray-50 p-3 rounded-lg border shadow-sm hover:border-red-400 transition';
                div.innerHTML = `
                    <label for="input-${className}" class="flex-none font-medium text-gray-700 w-16">${className}:</label>
                    <div class="relative flex-grow">
                        <input type="number" id="input-${className}" value="${currentValue}" min="1" step="1"
                               class="w-full pl-3 pr-2 py-2 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500 transition duration-150"
                               placeholder="Enter book count">
                    </div>
                `;
                
                const inputElement = div.querySelector(`#input-${className}`);
                
                // Event listener to save data on input blur (focus lost)
                inputElement.addEventListener('blur', (e) => {
                    let newValue = parseInt(e.target.value) || 1; 
                    if (newValue < 1) newValue = 1; 
                    e.target.value = newValue; 
                    
                    if (newValue !== currentValue) {
                        // Call the remote data update function
                        updateRemoteData(className, newValue); 
                    }
                });

                // Event listener to save data on Enter key press
                inputElement.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.target.blur(); 
                    }
                });

                inputForm.appendChild(div);
            });
        }

        /**
         * Creates or updates the Chart.js vertical bar chart.
         */
        function renderChart(data) {
            const { labels: chartLabels, totals: chartTotals, grandTotal, leader } = prepareData(data);
            if (chartLabels.length === 0) return;

            // Determine colors based on the unsorted list, highlighting the overall leader
            const chartBackgroundColors = chartTotals.map((total, index) => {
                // Check if the current bar is the leader
                const isWinner = chartLabels[index] === leader.name && total === leader.total;
                return isWinner ? '#f59e0b' : BAR_COLORS[index % BAR_COLORS.length]; // Gold for winner
            });

            const chartBorderColors = chartBackgroundColors.map(color => color === '#f59e0b' ? '#ca8a04' : color);

            // --- Update Summary DOM Element ---
            const totalSummaryDiv = document.getElementById('total-summary');
            const formattedTotal = new Intl.NumberFormat('en-US').format(grandTotal);
            const leaderName = leader.name || 'N/A';
            const leaderTotal = new Intl.NumberFormat('en-US').format(leader.total) || 'N/A';
            
            totalSummaryDiv.innerHTML = `
                <p class="text-xl font-bold text-red-800">
                    <span class="text-3xl font-extrabold">${formattedTotal}</span> TOTAL BOOKS COLLECTED
                </p>
                <p class="text-sm text-gray-700 mt-1">
                    Current Leader: <span class="font-bold text-red-600">${leaderName}</span> with ${leaderTotal} books!
                </p>
            `;
            // --- End Update Summary DOM Element ---

            // Destroy existing chart instance to force clean redraw
            if (chartInstance) {
                chartInstance.destroy();
                chartInstance = null;
            }

            // Create new chart instance
            chartInstance = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: chartLabels, // Unsorted order
                    datasets: [{
                        label: 'Books Collected',
                        data: chartTotals, // Unsorted order
                        backgroundColor: chartBackgroundColors,
                        borderColor: chartBorderColors,
                        borderWidth: 1,
                        borderRadius: 8,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 700 
                    },
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: 'Class Rankings (Unsorted Order)', 
                            color: '#b91c1c', 
                            font: { size: 18, weight: 'bold' }
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.y !== null) { 
                                        label += new Intl.NumberFormat('en-US').format(context.parsed.y) + ' books';
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { 
                            title: { display: true, text: 'Class Name', color: '#4b5563' },
                            ticks: { color: '#1f2937', font: { weight: 'bold', size: 14 } },
                            grid: { display: false }
                        },
                        y: { 
                            beginAtZero: true,
                            title: { display: true, text: 'Total Books', color: '#4b5563' },
                            ticks: {
                                color: '#1f2937',
                                callback: (value) => Intl.NumberFormat('en-US', { notation: 'compact' }).format(value)
                            }
                        }
                    }
                }
            });
        }
        
        // --- INITIALIZATION ---
        
        /**
         * Handles Firebase initialization and authentication.
         */
        async function initializeApp() {
            try {
                // Global variables from the environment
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                if (!firebaseConfig) {
                    throw new Error("Firebase configuration is missing.");
                }

                app = initApp(firebaseConfig);
                db = dbFn(app);
                auth = authFn(app);
                
                // Optional: Enable Firestore debug logs
                // setLogLevel('Debug');

                // 1. Handle Authentication
                onAuthChange(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        authStatus.textContent = "Real-time data enabled. All updates are instant.";
                        userInfo.innerHTML = `App ID: ${appId} | User ID: ${userId}`;
                        startRealtimeListener(); // Start listening only after auth is confirmed
                    } else {
                        isAuthReady = false;
                        authStatus.textContent = "Authentication required.";
                    }
                });

                // Try to sign in with the custom token or anonymously if not provided
                if (initialAuthToken) {
                    await signInCustom(auth, initialAuthToken);
                } else {
                    await signInAnon(auth);
                }

            } catch (error) {
                console.error("Initialization Error:", error);
                authStatus.textContent = `Initialization Error: ${error.message}`;
            }
        }

        initializeApp();
    </script>
</body>
</html>













