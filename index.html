<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Book Collection Tracker</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Setting font for aesthetics */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .bar-container {
            height: 1.75rem;
            background-color: #e2e8f0; /* Light gray background */
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05);
            margin-bottom: 0.5rem;
        }
        .bar-fill {
            height: 100%;
            transition: width 1s ease-in-out, background-color 0.3s;
            /* Base color is removed here; it's handled dynamically in JS */
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 0.5rem;
            font-weight: 600;
            color: white;
            white-space: nowrap;
            font-size: 0.875rem;
        }
    </style>
</head>
<body class="min-h-screen p-4 flex flex-col items-center">

    <div id="app-container" class="w-full max-w-5xl bg-white p-6 md:p-10 rounded-2xl shadow-2xl border border-gray-200 mt-8">
        <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900 mb-2 text-center">Class Book Collection Challenge</h1>
        <p class="text-gray-500 mb-6 text-center">Track book collection totals in real-time.</p>

        <!-- Status Message Area -->
        <div id="status-message" class="p-3 rounded-xl text-sm font-semibold mb-6 text-center bg-blue-100 text-blue-700">
            Initializing Firebase...
        </div>
        
        <!-- View Toggle Buttons -->
        <div class="flex justify-center space-x-4 mb-8">
            <button id="show-dashboard" class="px-6 py-2 rounded-lg font-medium text-white bg-blue-600 hover:bg-blue-700 shadow-md transition">
                Show Dashboard
            </button>
            <button id="show-data-entry" class="px-6 py-2 rounded-lg font-medium text-gray-700 bg-gray-200 hover:bg-gray-300 transition">
                Enter Scores
            </button>
        </div>

        <!-- Dashboard View (Chart and Totals) -->
        <div id="dashboard-view" class="space-y-8 p-4 border border-gray-100 rounded-xl shadow-inner">
            <!-- Removed the "Collection Results" h2 title -->

            <!-- Summary Totals -->
            <div class="flex justify-around text-center space-x-4">
                <div class="p-4 bg-green-50 rounded-lg w-1/2 border border-green-200">
                    <p class="text-lg font-medium text-gray-600">Total Books Collected</p>
                    <p id="total-books" class="text-4xl font-extrabold text-green-700 mt-1">0</p>
                </div>
                <div class="p-4 bg-yellow-50 rounded-lg w-1/2 border border-yellow-200">
                    <p class="text-lg font-medium text-gray-600">Current Leader</p>
                    <p id="highest-score-class" class="text-3xl font-extrabold text-yellow-700 mt-1">N/A</p>
                    <p id="highest-score-count" class="text-xl font-semibold text-yellow-600">0 Books</p>
                </div>
            </div>

            <!-- Bar Chart Area -->
            <div id="bar-chart-container" class="space-y-4">
                <p class="text-gray-500 text-center" id="chart-placeholder">Loading class data...</p>
            </div>
        </div>

        <!-- Data Entry View -->
        <div id="data-entry-view" class="hidden max-w-xl mx-auto p-4 border border-gray-100 rounded-xl shadow-inner">
            <h2 class="text-2xl font-bold text-gray-800 border-b pb-2 mb-4">Enter Class Scores</h2>
            <form id="scores-form" class="space-y-5">
                <!-- Inputs generated dynamically here -->
                <div id="class-inputs" class="grid grid-cols-2 gap-4">
                    <!-- Dynamic inputs will be placed here -->
                </div>

                <button type="submit" id="save-button"
                        class="w-full py-3 px-4 border border-transparent rounded-lg shadow-lg text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition ease-in-out duration-150">
                    Save All Scores
                </button>
            </form>
        </div>
        
    </div>

    <!-- Firebase Script Block -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL CONSTANTS & VARIABLES ---
        
        // List of classes to track
        const CLASS_NAMES = [
            '3F', '3V', '4S', '4T', '5L', '5N', '5W', '6Nw', '6SW', '7B', '7KV', '7SV'
        ];
        
        // List of vibrant Tailwind colors for the bars
        const BAR_COLORS = [
            'bg-purple-600', 'bg-blue-600', 'bg-teal-600', 'bg-green-600',
            'bg-yellow-600', 'bg-orange-600', 'bg-red-600', 'bg-pink-600',
            'bg-indigo-600', 'bg-lime-600', 'bg-cyan-600', 'bg-fuchsia-600'
        ];


        // Global variables for Firebase instances and user state
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        
        // DOM Elements
        const statusElement = document.getElementById('status-message');
        const dashboardView = document.getElementById('dashboard-view');
        const dataEntryView = document.getElementById('data-entry-view');
        const showDashboardButton = document.getElementById('show-dashboard');
        const showDataEntryButton = document.getElementById('show-data-entry');
        const scoresForm = document.getElementById('scores-form');
        const classInputsContainer = document.getElementById('class-inputs');
        const saveButton = document.getElementById('save-button');
        const totalBooksEl = document.getElementById('total-books');
        const highestScoreClassEl = document.getElementById('highest-score-class');
        const highestScoreCountEl = document.getElementById('highest-score-count');
        const chartContainer = document.getElementById('bar-chart-container');
        const chartPlaceholder = document.getElementById('chart-placeholder');

        // Stores the current scores for populating the form
        let currentScores = {};

        // --- UTILITIES & UI LOGIC ---

        // Function to update the UI status
        function updateStatus(message, isError = false) {
            statusElement.textContent = message;
            statusElement.className = `p-3 rounded-xl text-sm font-semibold mb-6 text-center ${isError ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
        }

        // Switches the visible view
        function switchView(viewName) {
            if (viewName === 'dashboard') {
                dashboardView.classList.remove('hidden');
                dataEntryView.classList.add('hidden');
                showDashboardButton.classList.add('bg-blue-600', 'text-white');
                showDashboardButton.classList.remove('bg-gray-200', 'text-gray-700');
                showDataEntryButton.classList.add('bg-gray-200', 'text-gray-700');
                showDataEntryButton.classList.remove('bg-blue-600', 'text-white');
            } else {
                dataEntryView.classList.remove('hidden');
                dashboardView.classList.add('hidden');
                showDataEntryButton.classList.add('bg-blue-600', 'text-white');
                showDataEntryButton.classList.remove('bg-gray-200', 'text-gray-700');
                showDashboardButton.classList.add('bg-gray-200', 'text-gray-700');
                showDashboardButton.classList.remove('bg-blue-600', 'text-white');
                // Ensure form is updated when switching to data entry
                renderDataEntryForm(currentScores);
            }
        }

        showDashboardButton.addEventListener('click', () => switchView('dashboard'));
        showDataEntryButton.addEventListener('click', () => switchView('data-entry'));

        // --- FIREBASE INITIALIZATION (FIXED) ---
        
        (async function initializeFirebaseApp() {
        
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            let firebaseConfig = null;
            if (typeof __firebase_config !== 'undefined') {
                try {
                    firebaseConfig = JSON.parse(__firebase_config);
                } catch (e) {
                    console.error("FIREBASE: Failed to parse __firebase_config JSON.", e);
                }
            }

            if (!firebaseConfig) {
                const errorMessage = "CRITICAL: Firebase configuration is missing. Cannot initialize Firebase app.";
                console.error(errorMessage);
                updateStatus(errorMessage, true);
                return; 
            }

            setLogLevel('Debug');

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Authentication
                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                
                userId = auth.currentUser?.uid; 
                isAuthReady = true;
                updateStatus(`Initialization successful! User: ${userId.substring(0, 8)}...`);

                // Start listening for data changes
                setupRealtimeListener();
                
                // Initialize to the dashboard view
                switchView('dashboard');

            } catch (initError) {
                const initErrorMessage = `FIREBASE INIT ERROR: ${initError.message}. Check console for details.`;
                console.error(initErrorMessage, initError);
                updateStatus(initErrorMessage, true);
            }
        })(); 


        // --- FIRESTORE DATA FUNCTIONS ---

        // Firestore Document Path: /artifacts/{appId}/users/{userId}/book_collection/class_scores
        const getScoresDocRef = () => {
            if (!isAuthReady || !db || !userId) return null;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const docPath = `/artifacts/${appId}/users/${userId}/book_collection/class_scores`;
            return doc(db, docPath);
        };

        /**
         * Listens for real-time updates to the class scores document.
         */
        function setupRealtimeListener() {
            const scoresRef = getScoresDocRef();
            if (!scoresRef) return;
            
            console.log("FIREBASE: Attaching real-time listener to class scores document.");

            onSnapshot(scoresRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    currentScores = data.scores || {};
                    console.log("FIREBASE: Scores received:", currentScores);
                    renderDashboard(currentScores);
                } else {
                    console.log("FIREBASE: No class scores data found. Initializing empty scores.");
                    // Use a clean slate of 0s if no data exists
                    currentScores = CLASS_NAMES.reduce((acc, name) => ({ ...acc, [name]: 0 }), {});
                    renderDashboard(currentScores);
                }
                updateStatus(`Data synchronized successfully! ${Object.keys(currentScores).length} classes tracked.`);
            }, (error) => {
                const fetchError = `FIREBASE FETCH ERROR: ${error.message}`;
                console.error(fetchError, error);
                updateStatus(fetchError, true);
            });
        }


        // --- DATA ENTRY VIEW LOGIC ---

        /**
         * Renders the input form fields, populating them with current scores.
         * @param {Object} scores - Current scores {className: count}.
         */
        function renderDataEntryForm(scores) {
            classInputsContainer.innerHTML = ''; // Clear previous inputs
            CLASS_NAMES.forEach(className => {
                const currentCount = scores[className] || 0;
                
                const inputGroup = document.createElement('div');
                inputGroup.className = 'flex flex-col';
                inputGroup.innerHTML = `
                    <label for="score-${className}" class="block text-sm font-medium text-gray-700">${className}</label>
                    <input type="number" id="score-${className}" name="${className}" value="${currentCount}" min="0" required 
                           class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                `;
                classInputsContainer.appendChild(inputGroup);
            });
        }

        // Form submission handler
        scoresForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!isAuthReady || !db || !userId) {
                updateStatus("System not ready. Please wait for initialization to complete.", true);
                return;
            }

            saveButton.disabled = true;
            saveButton.textContent = 'Saving...';
            
            const scoresRef = getScoresDocRef();
            if (!scoresRef) return;

            const newScores = {};
            let hasValidData = false;

            // Collect scores from all generated inputs
            CLASS_NAMES.forEach(className => {
                const inputEl = document.getElementById(`score-${className}`);
                const value = parseInt(inputEl.value, 10);
                if (!isNaN(value) && value >= 0) {
                    newScores[className] = value;
                    if (value > 0) hasValidData = true;
                } else {
                    // Default to 0 if input is invalid or empty
                    newScores[className] = 0;
                }
            });

            if (!hasValidData) {
                // Allows saving if all are 0, but gives a soft warning
                updateStatus("All scores are zero. Saving empty state.", false);
            }

            const documentData = {
                scores: newScores,
                lastUpdated: Date.now()
            };

            try {
                await setDoc(scoresRef, documentData);
                updateStatus("Class scores saved and chart updated successfully!");
                switchView('dashboard'); // Switch back to dashboard after saving
            } catch (error) {
                const saveError = `FIREBASE SAVE ERROR: ${error.message}`;
                console.error(saveError, error);
                updateStatus(saveError, true);
            } finally {
                saveButton.disabled = false;
                saveButton.textContent = 'Save All Scores';
            }
        });


        // --- DASHBOARD VIEW (CHART) LOGIC ---

        /**
         * Renders the bar chart and summary statistics.
         * @param {Object} scores - Current scores {className: count}.
         */
        function renderDashboard(scores) {
            
            // Convert map to array for sorting and processing
            const scoreArray = CLASS_NAMES.map(name => ({
                name: name,
                count: scores[name] || 0
            }));

            // 1. Calculate Totals and High Score
            let totalBooks = 0;
            let highestScore = 0;
            let highestScoreClass = 'N/A';
            
            scoreArray.forEach(item => {
                totalBooks += item.count;
                if (item.count > highestScore) {
                    highestScore = item.count;
                    highestScoreClass = item.name;
                } else if (item.count === highestScore && highestScoreClass === 'N/A' && item.count > 0) {
                    // Handle tie on first non-zero entry
                    highestScoreClass = item.name;
                }
            });
            
            // 2. Update Summary UI
            totalBooksEl.textContent = totalBooks.toLocaleString();
            highestScoreClassEl.textContent = highestScore > 0 ? highestScoreClass : 'N/A';
            highestScoreCountEl.textContent = `${highestScore.toLocaleString()} Books`;
            
            // 3. Render Bar Chart
            chartContainer.innerHTML = '';
            
            if (totalBooks === 0) {
                chartPlaceholder.textContent = "No books collected yet! Enter scores to begin.";
                chartPlaceholder.classList.remove('hidden');
                return;
            }
            
            chartPlaceholder.classList.add('hidden');

            scoreArray.sort((a, b) => b.count - a.count); // Sort descending for better visualization

            scoreArray.forEach((item, index) => {
                const { name, count } = item;
                // Calculate percentage based on the HIGHEST score for visualization scale
                const widthPercent = highestScore > 0 ? (count / highestScore) * 100 : 0;
                
                // Determine the base color by cycling through the color palette
                const baseColor = BAR_COLORS[index % BAR_COLORS.length];
                
                // Create bar element
                const barWrapper = document.createElement('div');
                barWrapper.className = 'flex items-center space-x-4';
                
                // Class Label
                const label = document.createElement('div');
                label.className = 'w-16 font-semibold text-gray-800 text-right';
                label.textContent = name;
                
                // Bar Container
                const barChartElement = document.createElement('div');
                barChartElement.className = 'flex-grow';
                
                // Bar Fill
                const barContainer = document.createElement('div');
                barContainer.className = 'bar-container';

                const barFill = document.createElement('div');
                barFill.className = 'bar-fill';
                barFill.style.width = `${widthPercent}%`;
                barFill.textContent = count.toLocaleString();
                
                // Highlight the winning class (Gold)
                if (count === highestScore && highestScore > 0) {
                    barFill.classList.add('bg-amber-500'); // Use amber/yellow for the winner
                    barFill.classList.remove(...BAR_COLORS); // Ensure other colors are removed
                } else {
                    // Apply the cycled base color
                    barFill.classList.add(baseColor);
                    barFill.classList.remove('bg-amber-500');
                }

                barContainer.appendChild(barFill);
                barChartElement.appendChild(barContainer);
                
                barWrapper.appendChild(label);
                barWrapper.appendChild(barChartElement);
                chartContainer.appendChild(barWrapper);
            });
        }

    </script>
</body>
</html>


















